{
    admin off
    log {
        level INFO
        format json {
            time_format "iso8601"
        }
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 10
        }
    }
}

{$DOMAIN:localhost} {
    @http {
        protocol http
    }
    redir @http https://{host}{uri} 301

    @health path /health
    handle @health {
        respond "OK" 200
    }

    @api path /api/*
    handle @api {
        reverse_proxy backend:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle /* {
        reverse_proxy frontend:8080 {
            header_up Host {host}
        }
    }

    tls {
        on_demand
    }
}
